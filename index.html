<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WalkView Pro - White Balance Edition</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap');
  :root {
    --bg:#0a0a0b;--surface:#111114;--border:#1e1e24;
    --accent:#c8ff00;--text:#e8e8e0;--muted:#555560;--panel-w:280px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;overflow:hidden;height:100vh;width:100vw;}
  #canvas-container{position:fixed;inset:0;z-index:0;}
  canvas{display:block;touch-action:none;}

  #ui{position:fixed;inset:0;z-index:10;pointer-events:none;}

  /* Top bar */
  #topbar{position:absolute;top:0;left:0;right:0;height:52px;background:linear-gradient(180deg,rgba(10,10,11,0.95) 0%,transparent 100%);display:flex;align-items:center;padding:0 20px;gap:16px;pointer-events:all;}
  #logo{font-size:13px;font-weight:800;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);}
  #model-name{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .btn{background:var(--accent);color:#0a0a0b;border:none;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:7px 14px;cursor:pointer;transition:opacity 0.15s;}
  .btn:hover{opacity:0.85;}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);}

  /* Panel toggle */
  #panel-toggle{position:absolute;top:52px;left:0;background:var(--surface);border:1px solid var(--border);border-left:none;padding:10px 8px;cursor:pointer;pointer-events:all;z-index:11;transition:left 0.3s;color:var(--text);}
  #panel-toggle.open{left:var(--panel-w);}

  /* Left panel */
  #panel-left{position:absolute;top:52px;left:0;bottom:0;width:var(--panel-w);background:rgba(10,10,11,0.9);backdrop-filter:blur(12px);border-right:1px solid var(--border);display:flex;flex-direction:column;transform:translateX(-100%);transition:transform 0.3s;pointer-events:all;overflow-y:auto;}
  #panel-left.open{transform:translateX(0);}

  .panel-section{border-bottom:1px solid var(--border);}
  .panel-header{padding:12px 20px;font-size:10px;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);cursor:pointer;display:flex;justify-content:space-between;}
  .panel-body{padding:8px 0;display:none;}
  .panel-body.open{display:block;}

  /* UI Components */
  .hdr-presets{padding:8px 12px;}
  .hdr-preset-btn{width:100%;text-align:left;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:4px;}
  .hdr-preset-btn.active{border-color:var(--accent);color:var(--accent);}

  .slider-row{display:flex;align-items:center;gap:6px;padding:5px 16px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
  .slider-row label{width:70px;flex-shrink:0;}
  .slider-row input[type="range"]{flex:1;height:3px;-webkit-appearance:none;background:var(--border);outline:none;border-radius:2px;}
  .slider-row input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:var(--accent);cursor:pointer;}
  .slider-val{width:34px;text-align:right;color:var(--text);}
  .slider-group-label{padding:12px 16px 4px;font-size:9px;font-weight:700;color:var(--accent);opacity:0.7;text-transform:uppercase;}
  input[type="color"]{background:none;border:1px solid var(--border);height:20px;width:40px;cursor:pointer;}
  select{background:var(--surface);color:var(--text);border:1px solid var(--border);font-size:10px;padding:2px;}

  /* Overlay */
  #overlay-msg{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;background:rgba(10,10,11,0.8);z-index:100;}
  .msg-box{background:var(--surface);border:1px solid var(--border);padding:40px;text-align:center;width:320px;}
  .url-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px;margin:15px 0;font-family:'DM Mono',monospace;}

  #crosshair{position:absolute;top:50%;left:50%;width:10px;height:10px;border:1px solid var(--accent);transform:translate(-50%,-50%);pointer-events:none;display:none;border-radius:50%;}
  #fps-badge{position:absolute;top:60px;right:20px;font-size:10px;color:var(--muted);font-family:'DM Mono';}
  #lock-msg{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--muted);background:rgba(0,0,0,0.5);padding:5px 15px;border-radius:20px;display:none;}
</style>
</head>
<body>

<div id="canvas-container"></div>
<div id="fps-badge">0 fps</div>
<div id="crosshair"></div>
<div id="lock-msg">CLICK TO EXPLORE</div>

<div id="ui">
  <div id="topbar">
    <div id="logo">Walk<span style="color:var(--text)">View</span> PRO</div>
    <div id="model-name">No Model Loaded</div>
    <button class="btn secondary" onclick="showLoadDialog()">LOAD GLB</button>
  </div>

  <button id="panel-toggle" onclick="togglePanel()">â˜°</button>

  <div id="panel-left">
    <div class="panel-section">
      <div class="panel-header open" onclick="toggleSection(this)"><span>ðŸ“· CAMERAS</span><span>â–¾</span></div>
      <div class="panel-body open" id="camera-list">
        <div style="padding:15px; font-size:10px; color:var(--muted);">Load a GLB to see cameras</div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-header" onclick="toggleSection(this)"><span>ðŸŒ… HDR (GRAY REFLECTION)</span><span>â–¾</span></div>
      <div class="panel-body">
        <div style="padding:0 16px 10px; font-size:9px; color:var(--muted);">Background is Color / Environment is Grayscale</div>
        <div class="slider-row">
          <label>Show BG</label>
          <input type="checkbox" id="hdr-bg-toggle" checked onchange="toggleHDRBackground()">
        </div>
        <div class="hdr-presets" id="hdr-presets"></div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-header" onclick="toggleSection(this)"><span>ðŸ’¡ LIGHTING & COLOR</span><span>â–¾</span></div>
      <div class="panel-body">
        <div class="slider-group-label">Tone Mapping</div>
        <div class="slider-row">
          <label>Type</label>
          <select id="sl-tone-type" onchange="updateLighting()">
            <option value="Neutral" selected>Neutral (Stable)</option>
            <option value="ACESFilmic">ACES Filmic</option>
            <option value="No">Linear</option>
          </select>
        </div>
        <div class="slider-row">
          <label>Exposure</label>
          <input type="range" min="0.1" max="4" step="0.05" value="1.0" id="sl-exposure" oninput="updateLighting()">
          <span class="slider-val" id="sv-exposure">1.0</span>
        </div>

        <div class="slider-group-label">Anti-Yellow (Hemisphere)</div>
        <div class="slider-row">
          <label>Strength</label>
          <input type="range" min="0" max="2" step="0.01" value="0.5" id="sl-hemi" oninput="updateLighting()">
          <span class="slider-val" id="sv-hemi">0.5</span>
        </div>
        <div class="slider-row">
          <label>Sky Color</label><input type="color" value="#ffffff" id="sl-hemi-sky" oninput="updateLighting()">
        </div>
        <div class="slider-row">
          <label>Gnd Color</label><input type="color" value="#ffffff" id="sl-hemi-gnd" oninput="updateLighting()">
        </div>

        <div class="slider-group-label">Environment</div>
        <div class="slider-row">
          <label>Reflection</label>
          <input type="range" min="0" max="2" step="0.1" value="1.0" id="sl-envmap" oninput="updateLighting()">
          <span class="slider-val" id="sv-envmap">1.0</span>
        </div>
        <div class="slider-row">
          <label>Rotation</label>
          <input type="range" min="0" max="360" step="1" value="0" id="sl-env-rot" oninput="updateLighting()">
          <span class="slider-val" id="sv-env-rot">0Â°</span>
        </div>
        <div class="slider-row">
          <label>Bloom</label>
          <input type="range" min="0" max="0.5" step="0.01" value="0.05" id="sl-bloom" oninput="updateLighting()">
          <span class="slider-val" id="sv-bloom">0.05</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="overlay-msg">
  <div class="msg-box">
    <div style="font-weight:800; letter-spacing:2px;">LOAD GLB MODEL</div>
    <input type="text" id="glb-url-input" class="url-input" placeholder="https://example.com/model.glb">
    <button class="btn" onclick="loadFromInput()" style="width:100%">LOAD</button>
    <button class="btn secondary" onclick="closeLoadDialog()" style="width:100%; margin-top:10px;">CANCEL</button>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

// --- CORE ---
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.NeutralToneMapping;
document.getElementById('canvas-container').appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a0a0b);

const walkCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
walkCamera.position.set(0, 1.6, 5);
let activeCamera = walkCamera;
let glbCameras = [];
let activeCamIdx = -1;

const composer = new EffectComposer(renderer);
const renderPass = new RenderPass(scene, walkCamera);
composer.addPass(renderPass);
const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.05, 0.4, 0.9);
composer.addPass(bloomPass);
composer.addPass(new OutputPass());

// --- LIGHTS ---
const ambient = new THREE.AmbientLight(0xffffff, 0.1);
scene.add(ambient);

const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
dirLight.position.set(10, 20, 10);
dirLight.castShadow = true;
dirLight.shadow.mapSize.set(2048, 2048);
scene.add(dirLight);

const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.5);
scene.add(hemiLight);

// --- HDR & MONO REFLECTION LOGIC ---
const rgbeLoader = new RGBELoader();
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();

let currentColorHDR = null;
let currentEnvMap = null;
let hdrBgEnabled = true;
let HDR_PRESETS = [];

async function loadHDR(idx) {
  if (!HDR_PRESETS[idx]) return;
  const url = './hdr/' + HDR_PRESETS[idx].file;
  
  rgbeLoader.load(url, (texture) => {
    // 1. Color for Background
    texture.mapping = THREE.EquirectangularReflectionMapping;
    currentColorHDR = texture;
    if (hdrBgEnabled) scene.background = currentColorHDR;

    // 2. Grayscale for Environment (Reflection)
    const img = texture.image;
    const data = img.data;
    const grayData = new data.constructor(data.length);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i+1], b = data[i+2];
      const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
      grayData[i] = grayData[i+1] = grayData[i+2] = luminance;
      if (data[i+3] !== undefined) grayData[i+3] = data[i+3];
    }

    const grayTex = new THREE.DataTexture(grayData, img.width, img.height, texture.format, texture.type);
    grayTex.mapping = THREE.EquirectangularReflectionMapping;
    grayTex.needsUpdate = true;

    if (currentEnvMap) currentEnvMap.dispose();
    currentEnvMap = pmremGenerator.fromEquirectangular(grayTex).texture;
    scene.environment = currentEnvMap;

    grayTex.dispose();
    document.querySelectorAll('.hdr-preset-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
  });
}

window.toggleHDRBackground = () => {
  hdrBgEnabled = document.getElementById('hdr-bg-toggle').checked;
  scene.background = (hdrBgEnabled && currentColorHDR) ? currentColorHDR : new THREE.Color(0x0a0a0b);
};

// --- MODEL LOADING ---
const draco = new DRACOLoader();
draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
const gltfLoader = new GLTFLoader();
gltfLoader.setDRACOLoader(draco);

let loadedModel = null;

window.loadFromInput = () => {
  const url = document.getElementById('glb-url-input').value.trim();
  if (url) loadGLB(url);
};

function loadGLB(url) {
  document.getElementById('overlay-msg').style.display = 'none';
  gltfLoader.load(url, (gltf) => {
    if (loadedModel) scene.remove(loadedModel);
    loadedModel = gltf.scene;
    
    loadedModel.traverse(child => {
      if (child.isMesh) {
        child.castShadow = child.receiveShadow = true;
        if (child.material) {
          const mats = Array.isArray(child.material) ? child.material : [child.material];
          mats.forEach(m => {
            if (m.isMeshStandardMaterial || m.isMeshPhysicalMaterial) m.envMapIntensity = 1.0;
          });
        }
      }
    });

    scene.add(loadedModel);
    document.getElementById('model-name').textContent = url.split('/').pop();
    
    // Cameras
    glbCameras = [];
    gltf.scene.traverse(node => { if (node.isCamera) glbCameras.push(node); });
    updateCameraUI();
    
    // Position walk camera
    const box = new THREE.Box3().setFromObject(loadedModel);
    const center = box.getCenter(new THREE.Vector3());
    walkCamera.position.set(center.x, center.y + 1.6, center.z + 5);
    walkCamera.lookAt(center);

    document.getElementById('lock-msg').style.display = 'block';
    updateLighting();
  });
}

function updateCameraUI() {
  const list = document.getElementById('camera-list');
  list.innerHTML = `<div style="padding:10px 20px; cursor:pointer; background:rgba(200,255,0,0.1);" onclick="switchCamera(-1)">ðŸš¶ WALKTHROUGH</div>`;
  glbCameras.forEach((cam, i) => {
    const el = document.createElement('div');
    el.style.padding = '10px 20px';
    el.style.cursor = 'pointer';
    el.style.fontSize = '10px';
    el.textContent = `ðŸ“· ${cam.name || 'Camera ' + i}`;
    el.onclick = () => switchCamera(i);
    list.appendChild(el);
  });
}

window.switchCamera = (idx) => {
  activeCamIdx = idx;
  activeCamera = idx === -1 ? walkCamera : glbCameras[idx];
  if (activeCamera.isPerspectiveCamera) {
    activeCamera.aspect = window.innerWidth / window.innerHeight;
    activeCamera.updateProjectionMatrix();
  }
};

// --- UI LOGIC ---
window.updateLighting = () => {
  const getNum = (id) => parseFloat(document.getElementById(id).value);
  const getVal = (id) => document.getElementById(id).value;

  const tone = getVal('sl-tone-type');
  renderer.toneMapping = tone === 'Neutral' ? THREE.NeutralToneMapping : tone === 'ACESFilmic' ? THREE.ACESFilmicToneMapping : THREE.NoToneMapping;
  renderer.toneMappingExposure = getNum('sl-exposure');

  hemiLight.intensity = getNum('sl-hemi');
  hemiLight.color.set(getVal('sl-hemi-sky'));
  hemiLight.groundColor.set(getVal('sl-hemi-gnd'));

  const envRot = getNum('sl-env-rot') * Math.PI / 180;
  scene.environmentRotation.y = envRot;
  if (scene.backgroundRotation) scene.backgroundRotation.y = envRot;

  const envInt = getNum('sl-envmap');
  if (loadedModel) {
    loadedModel.traverse(n => {
      if (n.isMesh && n.material) {
        const ms = Array.isArray(n.material) ? n.material : [n.material];
        ms.forEach(m => { if(m.envMapIntensity !== undefined) m.envMapIntensity = envInt; });
      }
    });
  }

  bloomPass.strength = getNum('sl-bloom');

  // Value display
  document.getElementById('sv-exposure').textContent = getNum('sl-exposure').toFixed(1);
  document.getElementById('sv-hemi').textContent = getNum('sl-hemi').toFixed(2);
  document.getElementById('sv-envmap').textContent = envInt.toFixed(1);
  document.getElementById('sv-env-rot').textContent = getVal('sl-env-rot') + 'Â°';
  document.getElementById('sv-bloom').textContent = getNum('sl-bloom').toFixed(2);
};

// --- CONTROLS & ANIMATION ---
let keys = {};
let yaw = 0, pitch = 0;

document.addEventListener('keydown', (e) => keys[e.code] = true);
document.addEventListener('keyup', (e) => keys[e.code] = false);
renderer.domElement.addEventListener('click', () => { if(activeCamIdx === -1) renderer.domElement.requestPointerLock(); });

document.addEventListener('mousemove', (e) => {
  if (document.pointerLockElement) {
    yaw -= e.movementX * 0.002;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch - e.movementY * 0.002));
  }
});

document.addEventListener('pointerlockchange', () => {
  const locked = !!document.pointerLockElement;
  document.getElementById('crosshair').style.display = locked ? 'block' : 'none';
  document.getElementById('lock-msg').style.display = locked ? 'none' : 'block';
});

function updateWalk() {
  if (activeCamIdx !== -1 || !document.pointerLockElement) return;
  const move = new THREE.Vector3();
  if (keys['KeyW']) move.z -= 1;
  if (keys['KeyS']) move.z += 1;
  if (keys['KeyA']) move.x -= 1;
  if (keys['KeyD']) move.x += 1;
  
  if (keys['Space']) walkCamera.position.y += 0.1;
  if (keys['ShiftLeft']) walkCamera.position.y -= 0.1;

  walkCamera.quaternion.setFromEuler(new THREE.Euler(pitch, yaw, 0, 'YXZ'));
  if (move.length() > 0) {
    move.normalize().multiplyScalar(0.1).applyQuaternion(new THREE.Quaternion().setFromEuler(new THREE.Euler(0, yaw, 0)));
    walkCamera.position.add(move);
  }
}

let lastTime = 0, frameCount = 0;
function animate(time) {
  requestAnimationFrame(animate);
  updateWalk();
  renderPass.camera = activeCamera;
  composer.render();

  frameCount++;
  if (time - lastTime > 1000) {
    document.getElementById('fps-badge').textContent = frameCount + ' fps';
    frameCount = 0; lastTime = time;
  }
}

// --- UTILS ---
window.togglePanel = () => {
  const p = document.getElementById('panel-left');
  const b = document.getElementById('panel-toggle');
  p.classList.toggle('open');
  b.classList.toggle('open');
};
window.toggleSection = (el) => {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
};
window.showLoadDialog = () => document.getElementById('overlay-msg').style.display = 'flex';
window.closeLoadDialog = () => document.getElementById('overlay-msg').style.display = 'none';

async function buildHDRPanel() {
  const container = document.getElementById('hdr-presets');
  try {
    const res = await fetch(`https://api.github.com/repos/${window.location.hostname.split('.')[0]}/${window.location.pathname.split('/')[1]}/contents/hdr`);
    if (!res.ok) throw new Error();
    const files = await res.json();
    HDR_PRESETS = files.filter(f => f.name.endsWith('.hdr')).map(f => ({ file: f.name }));
    if (HDR_PRESETS.length > 0) loadHDR(0);
  } catch(e) {
    container.innerHTML = '<div style="font-size:9px; color:var(--muted)">Put .hdr files in /hdr/ folder</div>';
  }
  
  HDR_PRESETS.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'hdr-preset-btn';
    btn.textContent = p.file;
    btn.onclick = () => loadHDR(i);
    container.appendChild(btn);
  });
}

window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
  walkCamera.aspect = window.innerWidth / window.innerHeight;
  walkCamera.updateProjectionMatrix();
});

// START
buildHDRPanel();
animate(0);

</script>
</body>
</html>