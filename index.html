<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLB Walkthrough Viewer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap');
  :root {
    --bg:#0a0a0b;--surface:#111114;--border:#1e1e24;
    --accent:#c8ff00;--text:#e8e8e0;--muted:#555560;--panel-w:280px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;overflow:hidden;height:100vh;width:100vw;}
  #canvas-container{position:fixed;inset:0;z-index:0;}
  canvas{display:block;}

  #ui{position:fixed;inset:0;z-index:10;pointer-events:none;}

  /* Top bar */
  #topbar{position:absolute;top:0;left:0;right:0;height:52px;background:linear-gradient(180deg,rgba(10,10,11,0.95) 0%,transparent 100%);display:flex;align-items:center;padding:0 20px;gap:16px;pointer-events:all;}
  #logo{font-size:13px;font-weight:800;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);}
  #model-name{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .btn{background:var(--accent);color:#0a0a0b;border:none;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:7px 14px;cursor:pointer;transition:opacity 0.15s;}
  .btn:hover{opacity:0.85;}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);}
  .btn.secondary:hover{border-color:var(--accent);color:var(--accent);}

  /* Panel toggle */
  #panel-toggle{position:absolute;top:52px;left:0;background:var(--surface);border:1px solid var(--border);border-left:none;padding:10px 8px;cursor:pointer;pointer-events:all;z-index:11;transition:left 0.3s cubic-bezier(0.16,1,0.3,1);font-size:14px;line-height:1;color:var(--text);font-family:monospace;}
  #panel-toggle.open{left:var(--panel-w);}

  /* Left panel */
  #panel-left{position:absolute;top:52px;left:0;bottom:0;width:var(--panel-w);background:rgba(10,10,11,0.9);backdrop-filter:blur(12px);border-right:1px solid var(--border);display:flex;flex-direction:column;transform:translateX(-100%);transition:transform 0.3s cubic-bezier(0.16,1,0.3,1);pointer-events:all;overflow-y:auto;}
  #panel-left.open{transform:translateX(0);}
  #panel-left::-webkit-scrollbar{width:3px;}
  #panel-left::-webkit-scrollbar-thumb{background:var(--border);}

  .panel-section{border-bottom:1px solid var(--border);}
  .panel-header{padding:12px 20px;font-size:10px;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:color 0.2s;}
  .panel-header:hover{color:var(--text);}
  .panel-header .arrow{font-size:10px;transition:transform 0.25s;}
  .panel-header.open .arrow{transform:rotate(180deg);}
  .panel-body{padding:8px 0;display:none;}
  .panel-body.open{display:block;}

  /* Camera list */
  .cam-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;transition:background 0.1s;border-left:2px solid transparent;}
  .cam-item:hover{background:rgba(200,255,0,0.05);}
  .cam-item.active{border-left-color:var(--accent);background:rgba(200,255,0,0.08);}
  .cam-icon{width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
  .cam-item.active .cam-icon{border-color:var(--accent);}
  .cam-label{font-family:'DM Mono',monospace;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

  /* HDR section */
  .hdr-presets{padding:8px 12px;}
  .hdr-preset-btn{width:100%;text-align:left;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;margin-bottom:4px;transition:all 0.2s;display:flex;align-items:center;gap:8px;}
  .hdr-preset-btn:hover{border-color:var(--accent);color:var(--accent);}
  .hdr-preset-btn.active{border-color:var(--accent);background:rgba(200,255,0,0.08);color:var(--accent);}
  .hdr-dot{width:24px;height:24px;border-radius:50%;flex-shrink:0;}

  .hdr-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 20px 12px;}
  .hdr-toggle-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
  .mini-toggle{position:relative;width:32px;height:18px;}
  .mini-toggle input{opacity:0;width:0;height:0;}
  .mini-slider{position:absolute;inset:0;background:rgba(255,255,255,0.1);border-radius:18px;cursor:pointer;transition:background 0.2s;}
  .mini-slider::before{content:'';position:absolute;width:12px;height:12px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform 0.2s;}
  .mini-toggle input:checked+.mini-slider{background:var(--accent);}
  .mini-toggle input:checked+.mini-slider::before{transform:translateX(14px);}

  /* Controls hint */
  #controls-hint{padding:14px 20px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);line-height:1.9;}
  .hint-key{display:inline-block;background:var(--border);padding:1px 5px;font-size:9px;color:var(--text);}

  /* Center overlay */
  #overlay-msg{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;}
  .msg-box{background:rgba(10,10,11,0.92);border:1px solid var(--border);padding:40px 48px;text-align:center;max-width:480px;width:90%;backdrop-filter:blur(20px);}
  .msg-title{font-size:28px;font-weight:800;letter-spacing:-0.02em;margin-bottom:8px;}
  .msg-title span{color:var(--accent);}
  .msg-sub{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);margin-bottom:28px;line-height:1.6;}
  .url-input-wrap{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
  .url-input{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:10px 14px;width:100%;outline:none;transition:border-color 0.2s;}
  .url-input:focus{border-color:var(--accent);}
  .url-input::placeholder{color:var(--muted);}
  .input-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:left;padding:0 2px;}
  #loading-bar-wrap{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--border);display:none;}
  #loading-bar{height:100%;background:var(--accent);width:0%;transition:width 0.2s;}

  /* Bottom right */
  #bottom-right{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:all;}
  #lock-msg{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(10,10,11,0.85);border:1px solid var(--border);padding:8px 16px;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);pointer-events:none;white-space:nowrap;display:none;}

  body.walking{cursor:none;}
  #crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;display:none;}
  #crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(200,255,0,0.8);}
  #crosshair::before{width:12px;height:1px;top:0;left:-6px;}
  #crosshair::after{width:1px;height:12px;top:-6px;left:0;}
  #fps-badge{position:absolute;top:60px;right:14px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);pointer-events:none;}

  @media(max-width:600px){:root{--panel-w:240px;}.msg-box{padding:28px 24px;}.msg-title{font-size:22px;}}
</style>
</head>
<body>
<div id="canvas-container"></div>
<div id="ui">
  <div id="topbar">
    <div id="logo">Walk<span style="color:var(--text)">View</span></div>
    <div id="model-name">GLBãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    <button class="btn secondary" id="btn-reload" style="display:none" onclick="showLoadDialog()">å¤‰æ›´</button>
  </div>

  <button id="panel-toggle" onclick="togglePanel()">â˜°</button>

  <div id="panel-left">
    <!-- Camera section -->
    <div class="panel-section">
      <div class="panel-header open" onclick="toggleSection(this)">
        <span>ğŸ“· ã‚«ãƒ¡ãƒ©</span><span class="arrow">â–¾</span>
      </div>
      <div class="panel-body open" id="camera-list">
        <div style="padding:16px 20px;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">GLBã‚’èª­ã¿è¾¼ã‚€ã¨è¡¨ç¤º</div>
      </div>
    </div>

    <!-- HDR section -->
    <div class="panel-section">
      <div class="panel-header" onclick="toggleSection(this)">
        <span>ğŸŒ… HDR ç’°å¢ƒå…‰</span><span class="arrow">â–¾</span>
      </div>
      <div class="panel-body" id="hdr-body">
        <div class="hdr-toggle-row">
          <span class="hdr-toggle-label">èƒŒæ™¯ã«è¡¨ç¤º</span>
          <label class="mini-toggle">
            <input type="checkbox" id="hdr-bg-toggle" checked onchange="toggleHDRBackground()">
            <div class="mini-slider"></div>
          </label>
        </div>
        <div class="hdr-presets" id="hdr-presets"></div>
      </div>
    </div>

    <!-- Controls -->
    <div style="margin-top:auto;">
      <div id="controls-hint">
        <span class="hint-key">W A S D</span> ç§»å‹•<br>
        <span class="hint-key">Mouse</span> è¦–ç‚¹<br>
        <span class="hint-key">Space</span> ä¸Šæ˜‡ &nbsp;<span class="hint-key">Shift</span> ä¸‹é™<br>
        <span class="hint-key">Esc</span> è§£æ”¾
      </div>
    </div>
  </div>

  <div id="overlay-msg">
    <div class="msg-box">
      <div class="msg-title">Walk<span>View</span></div>
      <div class="msg-sub">GLBã‚¦ã‚©ãƒ¼ã‚¯ã‚¹ãƒ«ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚¢<br>URLã‚’å…¥åŠ›ã—ã¦èª­ã¿è¾¼ã¿</div>
      <div class="url-input-wrap">
        <input class="url-input" id="glb-url-input" type="text" placeholder="https://...supabase.co/.../model.glb" />
        <div class="input-hint">ğŸ’¡ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã§ç”Ÿæˆã•ã‚ŒãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</div>
      </div>
      <button class="btn" onclick="loadFromInput()" style="width:100%;padding:12px">GLBã‚’èª­ã¿è¾¼ã‚€ â†’</button>
    </div>
    <div id="loading-bar-wrap"><div id="loading-bar"></div></div>
  </div>

  <div id="crosshair"></div>

  <div id="lock-msg">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ­©è¡Œãƒ¢ãƒ¼ãƒ‰é–‹å§‹ â€” Escã§è§£æ”¾</div>
  <div id="fps-badge"></div>
</div>

<script type="importmap">
{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

// ===== RENDERER =====
const container = document.getElementById('canvas-container');
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 0.003;
container.appendChild(renderer.domElement);

// ===== SCENE =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a0a0b);

const walkCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 500);
walkCamera.position.set(0, 1.6, 0);
let activeCamera = walkCamera;
let glbCameras = [];
let activeCamIdx = -1;

// ===== LIGHTING =====
const ambient = new THREE.AmbientLight(0xffffff, 500);
scene.add(ambient);

const dirLight = new THREE.DirectionalLight(0xffffff, 500);
dirLight.position.set(15, 30, 15);
dirLight.castShadow = true;
// é«˜å“è³ªå½±ã®è¨­å®š
dirLight.shadow.mapSize.width  = 4096;
dirLight.shadow.mapSize.height = 4096;
dirLight.shadow.camera.near    = 0.1;
dirLight.shadow.camera.far     = 300;
dirLight.shadow.camera.left    = -60;
dirLight.shadow.camera.right   =  60;
dirLight.shadow.camera.top     =  60;
dirLight.shadow.camera.bottom  = -60;
dirLight.shadow.bias           = -0.0005;
dirLight.shadow.normalBias     = 0.02;
scene.add(dirLight);

const hemiLight = new THREE.HemisphereLight(0xffffff, 0x888866, 100);
scene.add(hemiLight);

// ===== HDR =====
const rgbeLoader = new RGBELoader();
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();

// HDRãŒãªã„å ´åˆã§ã‚‚é»’ããªã‚‰ãªã„ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ç’°å¢ƒãƒãƒƒãƒ—ï¼ˆCanvasç”Ÿæˆï¼‰
{
  const c = document.createElement('canvas');
  c.width = 64; c.height = 32;
  const ctx = c.getContext('2d');
  const g = ctx.createLinearGradient(0, 0, 0, 32);
  g.addColorStop(0, '#aaaaaa');
  g.addColorStop(1, '#555555');
  ctx.fillStyle = g; ctx.fillRect(0, 0, 64, 32);
  const tex = new THREE.CanvasTexture(c);
  tex.mapping = THREE.EquirectangularReflectionMapping;
  const neutralEnv = pmremGenerator.fromEquirectangular(tex).texture;
  tex.dispose();
  scene.environment = neutralEnv;
}

let currentEnvMap = null;
let hdrBgEnabled = true;
let activeHdrIdx = -1;
let HDR_PRESETS = [];

async function buildHDRPanel() {
  const container = document.getElementById('hdr-presets');
  container.innerHTML = '<div style="padding:8px 12px;font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted)">èª­ã¿è¾¼ã¿ä¸­...</div>';

  try {
    // GitHub APIã§hdrãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
    // URLã‹ã‚‰ã‚ªãƒ¼ãƒŠãƒ¼ã¨ãƒªãƒã‚¸ãƒˆãƒªåã‚’æŠ½å‡º
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const repoName = pathParts[0] || '';
    const owner = window.location.hostname.split('.')[0];
    const apiUrl = `https://api.github.com/repos/${owner}/${repoName}/contents/hdr`;

    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error('API error');
    const files = await res.json();

    HDR_PRESETS = files
      .filter(f => f.name.toLowerCase().endsWith('.hdr'))
      .map(f => ({ file: f.name, label: f.name }));

    if (!HDR_PRESETS.length) throw new Error('HDRãƒ•ã‚¡ã‚¤ãƒ«ãªã—');

  } catch(e) {
    container.innerHTML = '<div style="padding:8px 12px;font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted)">hdr/ ãƒ•ã‚©ãƒ«ãƒ€ã«HDRãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }

  container.innerHTML = '';
  HDR_PRESETS.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'hdr-preset-btn';
    btn.id = 'hdr-btn-' + i;
    btn.textContent = p.file;
    btn.onclick = () => loadHDR(i);
    container.appendChild(btn);
  });

  // æœ€åˆã®HDRã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–ï¼‰
  if (HDR_PRESETS.length > 0) {
    loadHDR(0).catch(() => {});
  }
}

function loadHDR(idx) {
  const preset = HDR_PRESETS[idx];
  if (!preset) return Promise.resolve();
  document.querySelectorAll('.hdr-preset-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
  activeHdrIdx = idx;
  const url = './hdr/' + preset.file;
  return new Promise((resolve, reject) => {
    rgbeLoader.load(url, (texture) => {
      if (currentEnvMap) currentEnvMap.dispose();
      currentEnvMap = pmremGenerator.fromEquirectangular(texture).texture;
      texture.dispose();
      scene.environment = currentEnvMap;
      if (hdrBgEnabled) {
        scene.background = currentEnvMap;
        scene.backgroundIntensity = 500;
      }
      resolve();
    }, undefined, (err) => {
      console.warn('HDRèª­ã¿è¾¼ã¿å¤±æ•—:', url);
      reject(err);
    });
  });
}

window.toggleHDRBackground = function() {
  hdrBgEnabled = document.getElementById('hdr-bg-toggle').checked;
  if (hdrBgEnabled && currentEnvMap) {
    scene.background = currentEnvMap;
    scene.backgroundIntensity = 500;
    scene.fog = null;
  } else {
    scene.background = new THREE.Color(0x0a0a0b);
    scene.backgroundIntensity = 1;
    if (loadedModel) scene.fog = new THREE.Fog(0x0a0a0b, 30, 120);
  }
};

// ===== GLB LOADER =====
const dracoLoader = new DRACOLoader();
dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
const gltfLoader = new GLTFLoader();
gltfLoader.setDRACOLoader(dracoLoader);

let loadedModel = null;

window.loadFromInput = function() {
  const raw = document.getElementById('glb-url-input').value.trim();
  if (!raw) return;
  let url = raw;
  try { url = encodeURI(decodeURI(raw)); } catch(e) {}
  loadGLB(url, raw);
};

function loadGLB(url, displayUrl) {
  const overlay = document.getElementById('overlay-msg');
  const loadBar = document.getElementById('loading-bar-wrap');
  const loadBarInner = document.getElementById('loading-bar');
  loadBar.style.display = 'block';
  loadBarInner.style.width = '5%';

  const newUrl = new URL(window.location.href);
  newUrl.searchParams.set('glb', url);
  window.history.replaceState({}, '', newUrl.toString());

  gltfLoader.load(url, (gltf) => {
    if (loadedModel) scene.remove(loadedModel);
    loadedModel = gltf.scene;
    gltf.scene.traverse(obj => {
      if (obj.isMesh) {
        obj.castShadow = true;
        obj.receiveShadow = true;
      }
    });
    scene.add(gltf.scene);

    // Cameras
    glbCameras = [];
    gltf.scene.traverse(obj => { if (obj.isCamera) glbCameras.push(obj); });
    if (gltf.cameras) gltf.cameras.forEach(c => { if (!glbCameras.includes(c)) glbCameras.push(c); });
    glbCameras.forEach(cam => {
      if (cam.isPerspectiveCamera) { cam.aspect = window.innerWidth / window.innerHeight; cam.updateProjectionMatrix(); }
    });

    // Fit shadow camera to model
    const box = new THREE.Box3().setFromObject(gltf.scene);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    dirLight.shadow.camera.left   = -maxDim;
    dirLight.shadow.camera.right  =  maxDim;
    dirLight.shadow.camera.top    =  maxDim;
    dirLight.shadow.camera.bottom = -maxDim;
    dirLight.shadow.camera.far    = maxDim * 4;
    dirLight.shadow.camera.updateProjectionMatrix();
    dirLight.position.set(center.x + maxDim, center.y + maxDim * 1.5, center.z + maxDim);
    dirLight.target.position.copy(center);
    dirLight.target.updateMatrixWorld();

    // Walk camera position
    const eyeH = size.y * 0.35 + box.min.y;
    walkCamera.position.set(center.x + Math.max(size.x, size.z) * 0.4, eyeH, center.z + Math.max(size.x, size.z) * 0.4);
    walkCamera.lookAt(center);
    yaw = -Math.PI / 4; pitch = 0;

    buildCameraList();
    overlay.style.display = 'none';
    loadBar.style.display = 'none';
    document.getElementById('btn-reload').style.display = '';
    document.getElementById('lock-msg').style.display = 'block';
    const parts = (displayUrl || url).split('/');
    document.getElementById('model-name').textContent = decodeURIComponent(parts[parts.length - 1] || 'model.glb');
    activeCamIdx = -1; activeCamera = walkCamera;
  },
  (progress) => {
    if (progress.total > 0) loadBarInner.style.width = (progress.loaded / progress.total * 100).toFixed(0) + '%';
  },
  (error) => {
    loadBar.style.display = 'none';
    alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n' + error.message);
  });
}

function buildCameraList() {
  const list = document.getElementById('camera-list');
  list.innerHTML = '';
  const walkItem = document.createElement('div');
  walkItem.className = 'cam-item active'; walkItem.dataset.idx = '-1';
  walkItem.innerHTML = `<div class="cam-icon">ğŸš¶</div><div class="cam-label">ã‚¦ã‚©ãƒ¼ã‚¯ã‚¹ãƒ«ãƒ¼</div>`;
  walkItem.onclick = () => switchCamera(-1);
  list.appendChild(walkItem);
  if (!glbCameras.length) {
    const n = document.createElement('div');
    n.style = 'padding:8px 20px;font-family:"DM Mono",monospace;font-size:10px;color:var(--muted)';
    n.textContent = 'GLBå†…ã«ã‚«ãƒ¡ãƒ©ãªã—'; list.appendChild(n);
  } else {
    glbCameras.forEach((cam, i) => {
      const item = document.createElement('div');
      item.className = 'cam-item'; item.dataset.idx = i;
      item.innerHTML = `<div class="cam-icon">ğŸ“·</div><div class="cam-label">${cam.name || 'Camera ' + (i+1)}</div>`;
      item.onclick = () => switchCamera(i); list.appendChild(item);
    });
  }
}

window.switchCamera = function(idx) {
  activeCamIdx = idx;
  if (idx === -1) {
    activeCamera = walkCamera;
    document.getElementById('lock-msg').style.display = 'block';
  } else {
    activeCamera = glbCameras[idx];
    if (activeCamera.isPerspectiveCamera) { activeCamera.aspect = window.innerWidth / window.innerHeight; activeCamera.updateProjectionMatrix(); }
    document.getElementById('lock-msg').style.display = 'none';
    if (document.pointerLockElement) document.exitPointerLock();
    isLocked = false;
    document.getElementById('crosshair').style.display = 'none';
    document.body.classList.remove('walking');
  }
  document.querySelectorAll('.cam-item').forEach(el => el.classList.toggle('active', parseInt(el.dataset.idx) === idx));
};

// ===== WALK CONTROLS =====
let isLocked = false, yaw = 0, pitch = 0;
const keys = {};
const moveSpeed = 0.1;

renderer.domElement.addEventListener('click', () => {
  if (activeCamIdx !== -1 || !loadedModel) return;
  renderer.domElement.requestPointerLock();
});
document.addEventListener('pointerlockchange', () => {
  isLocked = !!document.pointerLockElement;
  document.getElementById('crosshair').style.display = isLocked ? 'block' : 'none';
  document.getElementById('lock-msg').style.display = isLocked ? 'none' : (loadedModel ? 'block' : 'none');
  document.body.classList.toggle('walking', isLocked);
});
document.addEventListener('mousemove', e => {
  if (!isLocked) return;
  yaw -= e.movementX * 0.002;
  pitch = Math.max(-Math.PI/2.2, Math.min(Math.PI/2.2, pitch - e.movementY * 0.002));
});
document.addEventListener('keydown', e => { keys[e.code] = true; });
document.addEventListener('keyup', e => { keys[e.code] = false; });

const euler = new THREE.Euler(0, 0, 0, 'YXZ');
const moveDir = new THREE.Vector3();
function updateWalk() {
  if (activeCamIdx !== -1) return;
  euler.set(pitch, yaw, 0); walkCamera.quaternion.setFromEuler(euler);
  moveDir.set(0, 0, 0);
  if (keys['KeyW']||keys['ArrowUp'])    moveDir.z -= 1;
  if (keys['KeyS']||keys['ArrowDown'])  moveDir.z += 1;
  if (keys['KeyA']||keys['ArrowLeft'])  moveDir.x -= 1;
  if (keys['KeyD']||keys['ArrowRight']) moveDir.x += 1;
  if (keys['Space'])                     moveDir.y += 1;
  if (keys['ShiftLeft']||keys['ShiftRight']) moveDir.y -= 1;
  if (moveDir.length() > 0) {
    moveDir.normalize().multiplyScalar(moveSpeed).applyQuaternion(new THREE.Quaternion().setFromEuler(new THREE.Euler(0, yaw, 0)));
    walkCamera.position.add(moveDir);
  }
}

// ===== PANEL / SECTION =====
let panelOpen = false;
window.togglePanel = function() {
  panelOpen = !panelOpen;
  document.getElementById('panel-left').classList.toggle('open', panelOpen);
  document.getElementById('panel-toggle').classList.toggle('open', panelOpen);
  document.getElementById('panel-toggle').textContent = panelOpen ? 'âœ•' : 'â˜°';
};
window.toggleSection = function(header) {
  header.classList.toggle('open');
  const body = header.nextElementSibling;
  body.classList.toggle('open');
};
window.showLoadDialog = function() {
  document.getElementById('overlay-msg').style.display = 'flex';
  document.getElementById('lock-msg').style.display = 'none';
};

// ===== RESIZE =====
window.addEventListener('resize', () => {
  walkCamera.aspect = window.innerWidth / window.innerHeight;
  walkCamera.updateProjectionMatrix();
  glbCameras.forEach(cam => { if (cam.isPerspectiveCamera) { cam.aspect = window.innerWidth / window.innerHeight; cam.updateProjectionMatrix(); } });
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// ===== RENDER LOOP =====
let lastTime = 0, frameCount = 0;
function animate(time) {
  requestAnimationFrame(animate);
  updateWalk();
  renderer.render(scene, activeCamera);
  frameCount++;
  if (time - lastTime > 1000) {
    document.getElementById('fps-badge').textContent = frameCount + ' fps';
    frameCount = 0; lastTime = time;
  }
}

// ===== INIT =====
buildHDRPanel(); // asyncã€ã‚¨ãƒ©ãƒ¼ã¯å†…éƒ¨ã§å‡¦ç†
animate(0);

// Auto-load from URL
const params = new URLSearchParams(window.location.search);
const autoGlb = params.get('glb');
if (autoGlb) {
  document.getElementById('glb-url-input').value = autoGlb;
  loadGLB(autoGlb, autoGlb);
}
</script>
</body>
</html>
