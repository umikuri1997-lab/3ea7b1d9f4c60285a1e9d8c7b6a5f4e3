<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLB ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230a0a0b'/><path d='M6 22 L11 10 L16 18 L19 13 L26 22Z' fill='%23c8ff00' opacity='0.9'/><circle cx='22' cy='10' r='3' fill='%23c8ff00' opacity='0.6'/></svg>">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap');
  :root {
    --bg:#0d0d10;--surface:#15151a;--surface2:#1c1c24;--border:rgba(255,255,255,0.07);
    --accent:#4fc3f7;--accent-dim:rgba(79,195,247,0.12);
    --success:#66bb6a;--success-dim:rgba(102,187,106,0.12);
    --warn:#ffa726;--danger:#ef5350;--text:#e8eaed;--muted:#9aa0a6;
    --font:'Noto Sans JP',sans-serif;--mono:'JetBrains Mono',monospace;--r:10px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:0 0 60px;}

  /* ===== HEADER ===== */
  #header {
    width:100%;background:var(--surface);border-bottom:1px solid var(--border);
    display:flex;align-items:center;padding:14px 20px;gap:12px;position:sticky;top:0;z-index:100;
  }
  #header .title{font-size:16px;font-weight:500;letter-spacing:1px;flex:1;}
  #header .title span{color:var(--accent);}
  .icon-btn{width:36px;height:36px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.2s;flex-shrink:0;}
  .icon-btn:hover{color:var(--text);border-color:rgba(255,255,255,0.2);}

  /* ===== SETTINGS DRAWER ===== */
  #drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;display:none;backdrop-filter:blur(4px);}
  #drawer-overlay.open{display:block;}
  #settings-drawer{
    position:fixed;top:0;right:0;height:100vh;width:340px;max-width:90vw;
    background:var(--surface);border-left:1px solid var(--border);z-index:300;
    transform:translateX(100%);transition:transform 0.3s cubic-bezier(0.16,1,0.3,1);
    display:flex;flex-direction:column;overflow-y:auto;
  }
  #settings-drawer.open{transform:translateX(0);}
  .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border);}
  .drawer-header h2{font-size:14px;font-weight:500;letter-spacing:1px;}
  .drawer-section{padding:20px;}
  .drawer-section+.drawer-section{border-top:1px solid var(--border);}
  .section-title{font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}

  /* ===== MAIN CONTENT ===== */
  #main{width:100%;max-width:560px;padding:24px 20px;}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:16px;}
  .card-title{font-size:11px;font-weight:500;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}

  /* Drop zone */
  #drop-zone{border:2px dashed rgba(255,255,255,0.1);border-radius:var(--r);padding:52px 24px;text-align:center;cursor:pointer;transition:all 0.25s;}
  #drop-zone:hover,#drop-zone.drag-over{border-color:var(--accent);background:var(--accent-dim);}
  #drop-zone .drop-icon{font-size:44px;margin-bottom:14px;opacity:0.5;}
  #drop-zone p{font-size:15px;color:var(--muted);margin-bottom:4px;}
  #drop-zone .hint{font-size:11px;color:rgba(255,255,255,0.2);}
  #file-input{display:none;}

  /* File queue */
  #file-queue{display:flex;flex-direction:column;gap:8px;}
  .file-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px;}
  .file-icon{font-size:20px;flex-shrink:0;margin-top:2px;}
  .file-info{flex:1;min-width:0;}
  .file-orig{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;}
  .file-new{font-family:var(--mono);font-size:12px;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .file-size{font-size:10px;color:var(--muted);margin-top:3px;}
  .file-status{font-size:11px;padding:3px 8px;border-radius:4px;flex-shrink:0;align-self:flex-start;margin-top:2px;}
  .file-status.pending{background:rgba(255,255,255,0.05);color:var(--muted);}
  .file-status.processing{background:rgba(79,195,247,0.15);color:var(--accent);}
  .file-status.done{background:var(--success-dim);color:var(--success);}
  .file-status.error{background:rgba(239,83,80,0.15);color:var(--danger);}
  .file-remove{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0 4px;align-self:flex-start;transition:color 0.2s;}
  .file-remove:hover{color:var(--danger);}
  .progress-wrap{height:3px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden;display:none;}
  .progress-wrap.visible{display:block;}
  .progress-bar{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width 0.2s;}
  .result-section{margin-top:10px;display:none;}
  .result-section.visible{display:block;}
  .result-label{font-size:10px;color:var(--muted);margin-bottom:4px;margin-top:8px;letter-spacing:0.5px;}
  .url-row{display:flex;gap:6px;align-items:center;margin-bottom:2px;}
  .url-text{flex:1;font-family:var(--mono);font-size:10px;color:var(--success);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:var(--success-dim);padding:5px 8px;border-radius:5px;border:1px solid rgba(102,187,106,0.2);cursor:text;user-select:all;}
  .url-text.viewer{color:var(--accent);background:var(--accent-dim);border-color:rgba(79,195,247,0.2);}
  .copy-btn{padding:5px 10px;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--muted);font-size:11px;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
  .copy-btn:hover{color:var(--text);border-color:rgba(255,255,255,0.2);}
  .copy-btn.copied{color:var(--success);border-color:var(--success);}
  .qr-wrap{display:flex;align-items:flex-start;gap:14px;margin-top:10px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid var(--border);}
  .qr-wrap canvas{flex-shrink:0;border-radius:4px;}
  .qr-info .qr-title{font-size:12px;color:var(--accent);margin-bottom:5px;font-weight:500;}
  .qr-info .qr-hint{font-size:11px;color:var(--muted);line-height:1.7;}

  /* Upload btn */
  #upload-section{display:none;}
  #upload-section.visible{display:block;}
  .btn-row{display:flex;gap:8px;}
  .btn{width:100%;padding:11px;background:var(--accent);border:none;border-radius:7px;color:#000;font-size:13px;font-weight:500;font-family:var(--font);cursor:pointer;transition:opacity 0.2s;}
  .btn:hover{opacity:0.85;}.btn:disabled{opacity:0.4;cursor:not-allowed;}
  .btn.secondary{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
  .btn.secondary:hover{color:var(--text);border-color:rgba(255,255,255,0.2);}
  .btn-row .btn{flex:1;}

  /* Log */
  #log-area{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;display:none;}
  #log-area.visible{display:block;}
  #log-content{font-family:var(--mono);font-size:11px;color:var(--muted);max-height:140px;overflow-y:auto;line-height:1.8;}
  .log-ok{color:var(--success);}.log-err{color:var(--danger);}.log-info{color:var(--accent);}

  /* Drawer form elements */
  .field{margin-bottom:12px;}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:5px;}
  .field input{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--mono);font-size:12px;outline:none;transition:border-color 0.2s;}
  .field input:focus{border-color:var(--accent);}
  .field input::placeholder{color:rgba(255,255,255,0.2);}
  .drawer-btn{width:100%;padding:10px;background:var(--accent);border:none;border-radius:7px;color:#000;font-size:13px;font-weight:500;font-family:var(--font);cursor:pointer;transition:opacity 0.2s;margin-top:4px;}
  .drawer-btn:hover{opacity:0.85;}
  .config-saved{font-size:11px;color:var(--success);margin-top:8px;display:none;text-align:center;}

  .option-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
  .option-row:last-child{border-bottom:none;}
  .toggle{position:relative;width:36px;height:20px;flex-shrink:0;}
  .toggle input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;inset:0;background:rgba(255,255,255,0.1);border-radius:20px;cursor:pointer;transition:background 0.2s;}
  .toggle-slider::before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform 0.2s;}
  .toggle input:checked+.toggle-slider{background:var(--accent);}
  .toggle input:checked+.toggle-slider::before{transform:translateX(16px);}
  .option-label{flex:1;font-size:13px;}
  .option-desc{font-size:10px;color:var(--muted);}
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <div class="title">GLB <span>Upload</span></div>
  <button class="icon-btn" onclick="openDrawer()" title="è¨­å®š">âš™ï¸</button>
</div>

<!-- Settings Drawer -->
<div id="drawer-overlay" onclick="closeDrawer()"></div>
<div id="settings-drawer">
  <div class="drawer-header">
    <h2>è¨­å®š</h2>
    <button class="icon-btn" onclick="closeDrawer()">âœ•</button>
  </div>

  <div class="drawer-section">
    <div class="section-title">âš™ï¸ Supabaseï¼ˆåˆå›ã®ã¿ï¼‰</div>
    <div class="field">
      <label>Project URL</label>
      <input type="text" id="supabase-url" placeholder="https://xxxxxxxxxxxx.supabase.co" />
    </div>
    <div class="field">
      <label>Service Role Key</label>
      <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIs..." />
    </div>
    <div class="field">
      <label>ãƒã‚±ãƒƒãƒˆå</label>
      <input type="text" id="supabase-bucket" value="glb-models" />
    </div>
    <div class="field">
      <label>ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼URLï¼ˆQRã«ä½¿ç”¨ï¼‰</label>
      <input type="text" id="viewer-url" placeholder="https://umikuri1997-lab.github.io/3ea7b1d9f4c60285a1e9d8c7b6a5f4e3/" />
    </div>
    <button class="drawer-btn" onclick="saveConfig()">è¨­å®šã‚’ä¿å­˜</button>
    <div class="config-saved" id="config-saved">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</div>
  </div>

  <div class="drawer-section">
    <div class="section-title">ğŸ”§ å‡¦ç†ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
    <div class="option-row">
      <label class="toggle"><input type="checkbox" id="opt-rename" checked><div class="toggle-slider"></div></label>
      <div><div class="option-label">æ—¥æœ¬èªãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›</div><div class="option-desc">æ—¥æœ¬èªãƒ»è¨˜å·å«ã‚€å ´åˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—IDã«å¤‰æ›</div></div>
    </div>
    <div class="option-row">
      <label class="toggle"><input type="checkbox" id="opt-lights" checked><div class="toggle-slider"></div></label>
      <div><div class="option-label">GLBå†…ã®ãƒ©ã‚¤ãƒˆã‚’æ•´ç†</div><div class="option-desc">Spotãƒ©ã‚¤ãƒˆã®ã¿æ®‹ã—ã€ä»–ã‚’å‰Šé™¤</div></div>
    </div>
    <div class="option-row">
      <label class="toggle"><input type="checkbox" id="opt-compress" checked><div class="toggle-slider"></div></label>
      <div><div class="option-label">ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’åœ§ç¸®</div><div class="option-desc">ãƒªã‚µã‚¤ã‚ºï¼†åœ§ç¸®ï¼ˆé€éã¯PNGä¿æŒï¼‰</div></div>
    </div>
    <div id="compress-options" style="padding:8px 0 0 46px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <label style="font-size:11px;color:var(--muted);width:80px;">æœ€å¤§ã‚µã‚¤ã‚º</label>
        <select id="opt-tex-size" style="padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:11px;">
          <option value="4096">4096px</option>
          <option value="2048" selected>2048px</option>
          <option value="1024">1024px</option>
          <option value="512">512px</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <label style="font-size:11px;color:var(--muted);width:80px;">JPEGå“è³ª</label>
        <select id="opt-tex-quality" style="padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:11px;">
          <option value="0.9">90%ï¼ˆé«˜å“è³ªï¼‰</option>
          <option value="0.75" selected>75%ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
          <option value="0.6">60%ï¼ˆå°ã‚µã‚¤ã‚ºï¼‰</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Main -->
<div id="main">

  <!-- Drop Zone (ä¸€ç•ªä¸Š) -->
  <div class="card">
    <div id="drop-zone" onclick="document.getElementById('file-input').click()">
      <div class="drop-icon">ğŸ“¦</div>
      <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
      <div class="hint">.glb ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°å¯ï¼‰</div>
    </div>
    <input type="file" id="file-input" accept=".glb" multiple>
  </div>

  <!-- Queue -->
  <div class="card" id="queue-card" style="display:none">
    <div class="card-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¼</div>
    <div id="file-queue"></div>
  </div>

  <!-- Upload btn -->
  <div id="upload-section">
    <div class="card">
      <div class="btn-row">
        <button class="btn secondary" onclick="clearQueue()">ã‚¯ãƒªã‚¢</button>
        <button class="btn" id="btn-upload" onclick="uploadAll()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ â†’</button>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div id="log-area">
    <div class="card-title" style="margin-bottom:8px">ğŸ“ ãƒ­ã‚°</div>
    <div id="log-content"></div>
  </div>

</div>

<script>
// DRAWER
function openDrawer(){document.getElementById('settings-drawer').classList.add('open');document.getElementById('drawer-overlay').classList.add('open');}
function closeDrawer(){document.getElementById('settings-drawer').classList.remove('open');document.getElementById('drawer-overlay').classList.remove('open');}

// CONFIG
function saveConfig(){
  const u=document.getElementById('supabase-url').value.trim();
  const k=document.getElementById('supabase-key').value.trim();
  if(!u||!k){alert('URLã¨ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  localStorage.setItem('sb_url',u);
  localStorage.setItem('sb_key',k);
  localStorage.setItem('sb_bucket',document.getElementById('supabase-bucket').value.trim()||'glb-models');
  localStorage.setItem('viewer_url',document.getElementById('viewer-url').value.trim());
  const m=document.getElementById('config-saved');m.style.display='block';
  setTimeout(()=>m.style.display='none',2000);
}
function loadConfig(){
  document.getElementById('supabase-url').value=localStorage.getItem('sb_url')||'';
  document.getElementById('supabase-key').value=localStorage.getItem('sb_key')||'';
  document.getElementById('supabase-bucket').value=localStorage.getItem('sb_bucket')||'glb-models';
  document.getElementById('viewer-url').value=localStorage.getItem('viewer_url')||'';
}

// RENAME (åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«å â†’ å¸¸ã«åŒã˜å‡ºåŠ›å)
function toSafe(name){
  const dot=name.lastIndexOf('.');
  const ext=dot>0?name.slice(dot):'.glb';
  const base=dot>0?name.slice(0,dot):name;
  if(!/[^\x00-\x7F]/.test(base)&&!/[^a-zA-Z0-9_\-]/.test(base))return name;
  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆåŒã˜å…¥åŠ›â†’åŒã˜å‡ºåŠ›ï¼‰
  let hash=0;
  for(let i=0;i<base.length;i++){hash=((hash<<5)-hash)+base.charCodeAt(i);hash|=0;}
  const hashStr=(hash>>>0).toString(36).toUpperCase();
  let a=base.replace(/[^\x00-\x7F]/g,'').replace(/[^a-zA-Z0-9_\-]/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'');
  if(!a)a='model';
  return a+'_'+hashStr+ext;
}

// LIGHT REMOVAL
async function removeLights(buf){
  const v=new DataView(buf);
  if(v.getUint32(0,true)!==0x46546C67)throw new Error('GLBãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
  const ver=v.getUint32(4,true);
  let off=12,jOff=-1,jLen=0,bOff=-1,bLen=0;
  while(off<buf.byteLength){const cLen=v.getUint32(off,true),cType=v.getUint32(off+4,true);if(cType===0x4E4F534A){jOff=off+8;jLen=cLen;}else if(cType===0x004E4942){bOff=off;bLen=cLen;}off+=8+cLen;}
  if(jOff<0)throw new Error('JSONãƒãƒ£ãƒ³ã‚¯ãªã—');
  const g=JSON.parse(new TextDecoder().decode(new Uint8Array(buf,jOff,jLen)));
  let removed=0, kept=0;

  const lights = g.extensions?.KHR_lights_punctual?.lights || [];
  if(lights.length > 0){
    // Spotã‚’å«ã‚€ãƒ©ã‚¤ãƒˆã ã‘æ®‹ã™ï¼ˆåå‰ or type ã§åˆ¤å®šï¼‰
    const indexMap = new Array(lights.length).fill(-1);
    const newLights = [];
    lights.forEach((light, i) => {
      const isSpot = /spot/i.test(light.name || '');
      if(isSpot){
        indexMap[i] = newLights.length;
        newLights.push(light);
        kept++;
      } else {
        removed++;
      }
    });

    // ãƒãƒ¼ãƒ‰ã®ãƒ©ã‚¤ãƒˆå‚ç…§ã‚’æ›´æ–°/å‰Šé™¤
    (g.nodes||[]).forEach(nd => {
      if(nd.extensions?.KHR_lights_punctual){
        const oldIdx = nd.extensions.KHR_lights_punctual.light;
        const newIdx = (oldIdx !== undefined && oldIdx < indexMap.length) ? indexMap[oldIdx] : -1;
        if(newIdx >= 0){
          nd.extensions.KHR_lights_punctual.light = newIdx;
        } else {
          delete nd.extensions.KHR_lights_punctual;
          if(nd.extensions && !Object.keys(nd.extensions).length) delete nd.extensions;
        }
      }
    });

    if(newLights.length > 0){
      g.extensions.KHR_lights_punctual.lights = newLights;
    } else {
      delete g.extensions.KHR_lights_punctual;
      if(g.extensions && !Object.keys(g.extensions).length) delete g.extensions;
      ['extensionsUsed','extensionsRequired'].forEach(k=>{
        if(g[k]){g[k]=g[k].filter(e=>e!=='KHR_lights_punctual');if(!g[k].length)delete g[k];}
      });
    }
  }

  let js=JSON.stringify(g);while(js.length%4)js+=' ';
  const jb=new TextEncoder().encode(js);
  const tot=12+8+jb.length+(bOff>=0?8+bLen:0);
  const ob=new ArrayBuffer(tot);const ov=new DataView(ob);const oa=new Uint8Array(ob);
  ov.setUint32(0,0x46546C67,true);ov.setUint32(4,ver,true);ov.setUint32(8,tot,true);
  ov.setUint32(12,jb.length,true);ov.setUint32(16,0x4E4F534A,true);oa.set(jb,20);
  if(bOff>=0){const bs=20+jb.length;ov.setUint32(bs,bLen,true);ov.setUint32(bs+4,0x004E4942,true);oa.set(new Uint8Array(buf,bOff+8,bLen),bs+8);}
  return{buffer:ob, removed, kept};
}

// TEXTURE COMPRESSION
async function compressTextures(buf, maxSize, quality) {
  const v = new DataView(buf);
  if (v.getUint32(0, true) !== 0x46546C67) throw new Error('GLBãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
  const ver = v.getUint32(4, true);

  // ãƒãƒ£ãƒ³ã‚¯è§£æ
  let off = 12, jOff = -1, jLen = 0, bOff = -1, bLen = 0;
  while (off < buf.byteLength) {
    const cLen = v.getUint32(off, true), cType = v.getUint32(off + 4, true);
    if (cType === 0x4E4F534A) { jOff = off + 8; jLen = cLen; }
    else if (cType === 0x004E4942) { bOff = off + 8; bLen = cLen; }
    off += 8 + cLen;
  }
  if (jOff < 0) throw new Error('JSONãƒãƒ£ãƒ³ã‚¯ãªã—');

  const g = JSON.parse(new TextDecoder().decode(new Uint8Array(buf, jOff, jLen)));
  if (!g.images || !g.images.length || bOff < 0) return { buffer: buf, saved: 0 };

  const binData = new Uint8Array(buf, bOff, bLen);
  const bvs = g.bufferViews || [];

  // å„ç”»åƒã‚’åœ§ç¸®ã—ã¦å·®ã—æ›¿ãˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹
  const newImageChunks = []; // {index, data: Uint8Array}
  let totalSaved = 0;
  let compressed = 0;

  for (let i = 0; i < g.images.length; i++) {
    const img = g.images[i];
    if (img.bufferView === undefined) continue;
    const bv = bvs[img.bufferView];
    if (!bv) continue;

    const imgOff = bv.byteOffset || 0;
    const imgLen = bv.byteLength;
    const origBytes = binData.slice(imgOff, imgOff + imgLen);

    // ç”»åƒã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰
    const blob = new Blob([origBytes], { type: img.mimeType || 'image/png' });
    const url = URL.createObjectURL(blob);

    try {
      const result = await new Promise((resolve, reject) => {
        const el = new Image();
        el.onload = () => {
          let w = el.width, h = el.height;
          // ãƒªã‚µã‚¤ã‚ºä¸è¦ã‹ã¤æ—¢ã«JPEGãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
          const isJpeg = (img.mimeType === 'image/jpeg');
          if (w <= maxSize && h <= maxSize && isJpeg) {
            resolve(null); return;
          }
          // ãƒªã‚µã‚¤ã‚º
          if (w > maxSize || h > maxSize) {
            const scale = maxSize / Math.max(w, h);
            w = Math.round(w * scale);
            h = Math.round(h * scale);
          }
          const c = document.createElement('canvas');
          c.width = w; c.height = h;
          const ctx = c.getContext('2d');
          ctx.drawImage(el, 0, 0, w, h);

          // ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ã®æœ‰ç„¡ã‚’æ¤œå‡º
          const pxData = ctx.getImageData(0, 0, w, h).data;
          let hasAlpha = false;
          for (let p = 3; p < pxData.length; p += 4) {
            if (pxData[p] < 250) { hasAlpha = true; break; }
          }

          if (hasAlpha) {
            // é€éã‚ã‚Š â†’ PNGã§ä¿æŒï¼ˆãƒªã‚µã‚¤ã‚ºã®ã¿ï¼‰
            c.toBlob(b => {
              if (!b) { resolve(null); return; }
              b.arrayBuffer().then(ab => resolve({ data: new Uint8Array(ab), mime: 'image/png' }));
            }, 'image/png');
          } else {
            // é€éãªã— â†’ JPEGåœ§ç¸®
            c.toBlob(b => {
              if (!b) { resolve(null); return; }
              b.arrayBuffer().then(ab => resolve({ data: new Uint8Array(ab), mime: 'image/jpeg' }));
            }, 'image/jpeg', quality);
          }
        };
        el.onerror = () => reject(new Error('ç”»åƒãƒ­ãƒ¼ãƒ‰å¤±æ•—'));
        el.src = url;
      });
      URL.revokeObjectURL(url);

      if (result && result.data.length < imgLen) {
        newImageChunks.push({ bvIndex: img.bufferView, data: result.data, origLen: imgLen });
        totalSaved += imgLen - result.data.length;
        img.mimeType = result.mime;
        compressed++;
      }
    } catch (e) {
      URL.revokeObjectURL(url);
    }
  }

  if (!newImageChunks.length) return { buffer: buf, saved: 0, compressed: 0 };

  // ãƒã‚¤ãƒŠãƒªãƒãƒƒãƒ•ã‚¡ã‚’å†æ§‹ç¯‰
  // bufferViewã®offseté †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«ã‚³ãƒ”ãƒ¼
  const segments = []; // {start, end, replacement?}
  // å…¨bufferViewã®ç¯„å›²ã‚’ãƒãƒ¼ã‚¯
  const replaceMap = new Map();
  newImageChunks.forEach(c => replaceMap.set(c.bvIndex, c));

  // ãƒã‚¤ãƒŠãƒªã‚’å†æ§‹ç¯‰ï¼šç½®æ›å¯¾è±¡ã®bufferViewã®ãƒ‡ãƒ¼ã‚¿ã ã‘å·®ã—æ›¿ãˆ
  // ã¾ãšå…¨bufferViewã‚’é–‹å§‹ä½ç½®é †ã«ãƒªã‚¹ãƒˆåŒ–
  const bvEntries = bvs.map((bv, idx) => ({ idx, offset: bv.byteOffset || 0, length: bv.byteLength }));
  bvEntries.sort((a, b) => a.offset - b.offset);

  const newParts = [];
  let cursor = 0;

  for (const entry of bvEntries) {
    // ã‚«ãƒ¼ã‚½ãƒ«ã‹ã‚‰ã“ã®bufferViewã®é–‹å§‹ä½ç½®ã¾ã§ã®éš™é–“ã‚’åŸ‹ã‚ã‚‹
    if (entry.offset > cursor) {
      newParts.push(binData.slice(cursor, entry.offset));
    }

    const replacement = replaceMap.get(entry.idx);
    const newOffset = newParts.reduce((s, p) => s + p.length, 0);

    if (replacement) {
      // 4ãƒã‚¤ãƒˆã‚¢ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆ
      let data = replacement.data;
      const pad = (4 - data.length % 4) % 4;
      if (pad > 0) {
        const padded = new Uint8Array(data.length + pad);
        padded.set(data);
        data = padded;
      }
      newParts.push(data);
      bvs[entry.idx].byteOffset = newOffset;
      bvs[entry.idx].byteLength = replacement.data.length;
    } else {
      newParts.push(binData.slice(entry.offset, entry.offset + entry.length));
      bvs[entry.idx].byteOffset = newOffset;
    }

    cursor = entry.offset + entry.length;
  }

  // æ®‹ã‚Šã®ãƒ‡ãƒ¼ã‚¿
  if (cursor < bLen) {
    newParts.push(binData.slice(cursor));
  }

  // æ–°ãƒã‚¤ãƒŠãƒªçµåˆ
  const newBinLen = newParts.reduce((s, p) => s + p.length, 0);
  const newBin = new Uint8Array(newBinLen);
  let pos = 0;
  for (const p of newParts) { newBin.set(p, pos); pos += p.length; }

  // buffers[0]ã®ã‚µã‚¤ã‚ºæ›´æ–°
  if (g.buffers && g.buffers[0]) g.buffers[0].byteLength = newBinLen;

  // GLBå†æ§‹ç¯‰
  let js = JSON.stringify(g);
  while (js.length % 4) js += ' ';
  const jb = new TextEncoder().encode(js);
  const tot = 12 + 8 + jb.length + 8 + newBinLen;
  const ob = new ArrayBuffer(tot);
  const ov = new DataView(ob);
  const oa = new Uint8Array(ob);
  ov.setUint32(0, 0x46546C67, true);
  ov.setUint32(4, ver, true);
  ov.setUint32(8, tot, true);
  ov.setUint32(12, jb.length, true);
  ov.setUint32(16, 0x4E4F534A, true);
  oa.set(jb, 20);
  const bs = 20 + jb.length;
  ov.setUint32(bs, newBinLen, true);
  ov.setUint32(bs + 4, 0x004E4942, true);
  oa.set(newBin, bs + 8);

  return { buffer: ob, saved: totalSaved, compressed };
}

// QUEUE
let queue=[];
function addFiles(files){
  const doRename=document.getElementById('opt-rename').checked;
  Array.from(files).forEach(f=>{
    if(!f.name.toLowerCase().endsWith('.glb')){addLog(`ã‚¹ã‚­ãƒƒãƒ—: ${f.name}`,'err');return;}
    queue.push({file:f,newName:doRename?toSafe(f.name):f.name,status:'pending',id:Math.random().toString(36).slice(2)});
  });
  renderQueue();
}
function renderQueue(){
  const qc=document.getElementById('queue-card'),qf=document.getElementById('file-queue'),us=document.getElementById('upload-section');
  if(!queue.length){qc.style.display='none';us.style.display='none';return;}
  qc.style.display='block';us.classList.add('visible');
  qf.innerHTML='';
  queue.forEach((item,i)=>{
    const changed=item.newName!==item.file.name;
    const d=document.createElement('div');d.className='file-item';d.id='fi-'+item.id;
    d.innerHTML=`
      <div class="file-icon">ğŸ“¦</div>
      <div class="file-info">
        <div class="file-orig">${esc(item.file.name)}</div>
        <div class="file-new">${esc(item.newName)}${changed?` <span style="color:var(--warn);font-size:10px">âœ¦å¤‰æ›</span>`:''}</div>
        <div class="file-size">${(item.file.size/1024/1024).toFixed(1)} MB</div>
        <div class="progress-wrap" id="pw-${item.id}"><div class="progress-bar" id="pb-${item.id}"></div></div>
        <div class="result-section" id="rs-${item.id}"></div>
      </div>
      <span class="file-status pending" id="st-${item.id}">å¾…æ©Ÿä¸­</span>
      ${item.status==='pending'?`<button class="file-remove" onclick="removeFile(${i})">âœ•</button>`:''}
    `;
    qf.appendChild(d);
  });
}
function removeFile(i){queue.splice(i,1);renderQueue();}
function clearQueue(){queue=queue.filter(f=>f.status!=='pending');if(queue.every(f=>f.status!=='pending'))queue=[];renderQueue();}

// UPLOAD
async function uploadAll(){
  const sbUrl=localStorage.getItem('sb_url');
  const sbKey=localStorage.getItem('sb_key');
  const sbBucket=localStorage.getItem('sb_bucket')||'glb-models';
  const viewerBase=(localStorage.getItem('viewer_url')||'').replace(/\/?$/,'/');
  if(!sbUrl||!sbKey){alert('å³ä¸Šã®âš™ï¸ã‹ã‚‰è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');return;}
  const btn=document.getElementById('btn-upload');
  btn.disabled=true;btn.textContent='ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
  document.getElementById('log-area').classList.add('visible');
  const doLights=document.getElementById('opt-lights').checked;
  const doCompress=document.getElementById('opt-compress').checked;
  const texMaxSize=parseInt(document.getElementById('opt-tex-size').value);
  const texQuality=parseFloat(document.getElementById('opt-tex-quality').value);
  for(const item of queue){
    if(item.status!=='pending')continue;
    setSt(item.id,'processing','å‡¦ç†ä¸­...');showPw(item.id,true);setPb(item.id,5);
    addLog(`å‡¦ç†ä¸­: ${item.file.name} â†’ ${item.newName}`,'info');
    const origSize=item.file.size;
    try{
      let buf=await item.file.arrayBuffer();setPb(item.id,15);
      if(doLights){
        try{const r=await removeLights(buf);buf=r.buffer;addLog(`  ãƒ©ã‚¤ãƒˆ ${r.removed} å€‹å‰Šé™¤ / Spot ${r.kept} å€‹ä¿æŒ`,r.removed>0?'ok':'info');}
        catch(e){addLog(`  ãƒ©ã‚¤ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`,'err');}
      }
      setPb(item.id,25);
      if(doCompress){
        try{
          setSt(item.id,'processing','åœ§ç¸®ä¸­...');
          const r=await compressTextures(buf,texMaxSize,texQuality);
          buf=r.buffer;
          if(r.compressed>0){
            const savedMB=(r.saved/1024/1024).toFixed(1);
            const newMB=(buf.byteLength/1024/1024).toFixed(1);
            addLog(`  ãƒ†ã‚¯ã‚¹ãƒãƒ£ ${r.compressed} æšåœ§ç¸® (-${savedMB}MB â†’ ${newMB}MB)`,'ok');
          } else {
            addLog('  åœ§ç¸®å¯¾è±¡ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ãªã—','info');
          }
        }catch(e){addLog(`  ãƒ†ã‚¯ã‚¹ãƒãƒ£åœ§ç¸®ã‚¨ãƒ©ãƒ¼: ${e.message}`,'err');}
      }
      setPb(item.id,60);
      const res=await fetch(`${sbUrl}/storage/v1/object/${sbBucket}/${encodeURIComponent(item.newName)}`,{
        method:'POST',headers:{'Authorization':`Bearer ${sbKey}`,'Content-Type':'model/gltf-binary','x-upsert':'true'},
        body:new Blob([buf],{type:'model/gltf-binary'})
      });
      setPb(item.id,90);
      if(!res.ok)throw new Error(`HTTP ${res.status}: ${await res.text()}`);
      const glbUrl=`${sbUrl}/storage/v1/object/public/${sbBucket}/${encodeURIComponent(item.newName)}`;
      const viewerUrl=viewerBase?`${viewerBase}?glb=${encodeURIComponent(glbUrl)}`:glbUrl;
      item.status='done';setPb(item.id,100);setSt(item.id,'done','å®Œäº† âœ“');
      showResult(item.id,glbUrl,viewerUrl);
      addLog('  âœ“ å®Œäº†','ok');
    }catch(e){item.status='error';setSt(item.id,'error','ã‚¨ãƒ©ãƒ¼');addLog(`  âœ— ${e.message}`,'err');}
  }
  btn.disabled=false;btn.textContent='ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ â†’';
  addLog('--- å®Œäº† ---','info');
}

// RESULT
function showResult(id,glbUrl,viewerUrl){
  const sec=document.getElementById('rs-'+id);if(!sec)return;
  // QR: å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦ã€ç”»åƒAPIã‚’ä½¿ç”¨ï¼ˆCDNãƒ–ãƒ­ãƒƒã‚¯å•é¡Œã‚’å›é¿ï¼‰
  const qrImgUrl=`https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${encodeURIComponent(viewerUrl)}&margin=1`;
  sec.innerHTML=`
    <div class="result-label">GLBç›´æ¥URL</div>
    <div class="url-row"><div class="url-text" id="gu-${id}">${esc(glbUrl)}</div><button class="copy-btn" id="cgb-${id}" onclick="doCopy('gu-${id}','cgb-${id}')">ã‚³ãƒ”ãƒ¼</button></div>
    <div class="result-label">ğŸ”— ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼URL</div>
    <div class="url-row"><div class="url-text viewer" id="vu-${id}">${esc(viewerUrl)}</div><button class="copy-btn" id="cvb-${id}" onclick="doCopy('vu-${id}','cvb-${id}')">ã‚³ãƒ”ãƒ¼</button></div>
    <div class="qr-wrap">
      <img src="${qrImgUrl}" width="128" height="128" style="flex-shrink:0;border-radius:4px;background:#fff;" onerror="this.style.display='none'">
      <div class="qr-info"><div class="qr-title">ğŸ“± QRã‚³ãƒ¼ãƒ‰</div><div class="qr-hint">ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§<br>ã“ã®GLBãŒé–‹ãã¾ã™</div></div>
    </div>
  `;
  sec.classList.add('visible');
}

// HELPERS
function setSt(id,cls,txt){const e=document.getElementById('st-'+id);if(e){e.className='file-status '+cls;e.textContent=txt;}}
function showPw(id,v){const e=document.getElementById('pw-'+id);if(e)e.classList.toggle('visible',v);}
function setPb(id,p){const e=document.getElementById('pb-'+id);if(e)e.style.width=p+'%';}
function doCopy(textId,btnId){
  const t=document.getElementById(textId)?.textContent||'';
  const b=document.getElementById(btnId);
  navigator.clipboard.writeText(t).then(()=>{if(b){b.textContent='âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';b.classList.add('copied');setTimeout(()=>{b.textContent='ã‚³ãƒ”ãƒ¼';b.classList.remove('copied');},2000);}});
}
function addLog(msg,type='info'){const e=document.getElementById('log-content');const d=document.createElement('div');d.className='log-'+type;d.textContent=msg;e.appendChild(d);e.scrollTop=e.scrollHeight;}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// DRAG & DROP
const dz=document.getElementById('drop-zone'),fi=document.getElementById('file-input');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');addFiles(e.dataTransfer.files);});
fi.addEventListener('change',e=>{addFiles(e.target.files);e.target.value='';});

loadConfig();
</script>
</body>
</html>
