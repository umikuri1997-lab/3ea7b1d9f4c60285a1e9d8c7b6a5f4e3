<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLB ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0d0d10;
    --surface: #15151a;
    --surface2: #1c1c24;
    --border: rgba(255,255,255,0.07);
    --accent: #4fc3f7;
    --accent-dim: rgba(79,195,247,0.12);
    --success: #66bb6a;
    --success-dim: rgba(102,187,106,0.12);
    --warn: #ffa726;
    --danger: #ef5350;
    --text: #e8eaed;
    --muted: #9aa0a6;
    --font: 'Noto Sans JP', sans-serif;
    --mono: 'JetBrains Mono', monospace;
    --r: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 60px;
  }

  .page-title {
    font-size: 22px;
    font-weight: 500;
    letter-spacing: 2px;
    margin-bottom: 6px;
  }
  .page-title span { color: var(--accent); }

  .page-sub {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 32px;
  }

  .card {
    width: 100%;
    max-width: 560px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 24px;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  .field { margin-bottom: 12px; }

  .field label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 5px;
  }

  .field input {
    width: 100%;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .field input:focus { border-color: var(--accent); }
  .field input::placeholder { color: rgba(255,255,255,0.2); }

  .btn {
    width: 100%;
    padding: 11px;
    background: var(--accent);
    border: none;
    border-radius: 7px;
    color: #000;
    font-size: 13px;
    font-weight: 500;
    font-family: var(--font);
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn.secondary {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .btn.secondary:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }

  .config-saved {
    font-size: 11px;
    color: var(--success);
    margin-top: 8px;
    display: none;
  }

  /* Drop zone */
  #drop-zone {
    border: 2px dashed rgba(255,255,255,0.1);
    border-radius: var(--r);
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
  }

  #drop-zone:hover,
  #drop-zone.drag-over {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  #drop-zone .drop-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  #drop-zone p {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  #drop-zone .hint {
    font-size: 11px;
    color: rgba(255,255,255,0.2);
  }

  #file-input { display: none; }

  /* File queue */
  #file-queue {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .file-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .file-item .file-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }

  .file-item .file-info { flex: 1; min-width: 0; }

  .file-item .file-orig {
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
  }

  .file-item .file-new {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-item .file-size {
    font-size: 10px;
    color: var(--muted);
    margin-top: 3px;
  }

  .file-item .file-status {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    flex-shrink: 0;
    align-self: center;
  }

  .file-status.pending  { background: rgba(255,255,255,0.05); color: var(--muted); }
  .file-status.processing { background: rgba(79,195,247,0.15); color: var(--accent); }
  .file-status.done   { background: var(--success-dim); color: var(--success); }
  .file-status.error  { background: rgba(239,83,80,0.15); color: var(--danger); }

  .file-remove {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
    align-self: flex-start;
    transition: color 0.2s;
  }
  .file-remove:hover { color: var(--danger); }

  /* Progress bar */
  .progress-wrap {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
    display: none;
  }
  .progress-wrap.visible { display: block; }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    width: 0%;
    transition: width 0.2s;
  }

  /* Result URL */
  .result-url {
    margin-top: 6px;
    display: none;
  }
  .result-url.visible { display: block; }

  .url-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 4px;
  }

  .url-text {
    flex: 1;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--success);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: var(--success-dim);
    padding: 5px 8px;
    border-radius: 5px;
    border: 1px solid rgba(102,187,106,0.2);
    cursor: text;
    user-select: all;
  }

  .copy-btn {
    padding: 5px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--muted);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .copy-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .copy-btn.copied { color: var(--success); border-color: var(--success); }

  /* Options */
  .option-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .option-row:last-child { border-bottom: none; }

  .toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  .option-label {
    flex: 1;
    font-size: 13px;
  }
  .option-desc {
    font-size: 11px;
    color: var(--muted);
  }

  /* Upload all btn area */
  #upload-section { display: none; }
  #upload-section.visible { display: block; }

  .btn-row {
    display: flex;
    gap: 8px;
  }
  .btn-row .btn { flex: 1; }

  /* Log */
  #log-area {
    width: 100%;
    max-width: 560px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px;
    display: none;
  }
  #log-area.visible { display: block; }
  #log-content {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    max-height: 160px;
    overflow-y: auto;
    line-height: 1.8;
  }
  #log-content .log-ok { color: var(--success); }
  #log-content .log-err { color: var(--danger); }
  #log-content .log-info { color: var(--accent); }
</style>
</head>
<body>

<div class="page-title">GLB <span>Upload</span></div>
<div class="page-sub">æ—¥æœ¬èªãƒ•ã‚¡ã‚¤ãƒ«åã‚’è‹±èªã«å¤‰æ› ãƒ» ãƒ©ã‚¤ãƒˆå‰Šé™¤ ãƒ» Supabaseã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>

<!-- Supabase Config -->
<div class="card" id="config-card">
  <div class="card-title">âš™ï¸ Supabase è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰</div>
  <div class="field">
    <label>Project URL</label>
    <input type="text" id="supabase-url" placeholder="https://xxxxxxxxxxxx.supabase.co" />
  </div>
  <div class="field">
    <label>Anon Keyï¼ˆå…¬é–‹ã‚­ãƒ¼ï¼‰</label>
    <input type="text" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIs..." />
  </div>
  <div class="field">
    <label>ãƒã‚±ãƒƒãƒˆå</label>
    <input type="text" id="supabase-bucket" placeholder="glb-models" value="glb-models" />
  </div>
  <button class="btn" onclick="saveConfig()">è¨­å®šã‚’ä¿å­˜</button>
  <div class="config-saved" id="config-saved">âœ“ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>
</div>

<!-- Options -->
<div class="card">
  <div class="card-title">ğŸ”§ å‡¦ç†ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
  <div class="option-row">
    <label class="toggle">
      <input type="checkbox" id="opt-rename" checked>
      <div class="toggle-slider"></div>
    </label>
    <div>
      <div class="option-label">æ—¥æœ¬èªãƒ•ã‚¡ã‚¤ãƒ«åã‚’è‹±èªã«å¤‰æ›</div>
      <div class="option-desc">æ—¥æœ¬èªãƒ»è¨˜å·ã‚’å«ã‚€å ´åˆã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—IDã«å¤‰æ›ã—ã¾ã™</div>
    </div>
  </div>
  <div class="option-row">
    <label class="toggle">
      <input type="checkbox" id="opt-remove-lights" checked>
      <div class="toggle-slider"></div>
    </label>
    <div>
      <div class="option-label">GLBå†…ã®ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤</div>
      <div class="option-desc">Point / Spot / Directional ãƒ©ã‚¤ãƒˆã‚’ã™ã¹ã¦é™¤å»ã—ã¾ã™</div>
    </div>
  </div>
</div>

<!-- Drop Zone -->
<div class="card">
  <div class="card-title">ğŸ“ GLBãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </div>
  <div id="drop-zone" onclick="document.getElementById('file-input').click()">
    <div class="drop-icon">ğŸ“¦</div>
    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
    <div class="hint">.glb ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°å¯ï¼‰</div>
  </div>
  <input type="file" id="file-input" accept=".glb" multiple>
</div>

<!-- File Queue -->
<div class="card" id="queue-card" style="display:none">
  <div class="card-title">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¼</div>
  <div id="file-queue"></div>
</div>

<!-- Upload Button -->
<div class="card" id="upload-section">
  <div class="btn-row">
    <button class="btn secondary" onclick="clearQueue()">ã‚¯ãƒªã‚¢</button>
    <button class="btn" id="btn-upload" onclick="uploadAll()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ â†’</button>
  </div>
</div>

<!-- Log -->
<div id="log-area">
  <div class="card-title" style="margin-bottom:8px">ğŸ“ ãƒ­ã‚°</div>
  <div id="log-content"></div>
</div>

<script>
// ===== CONFIG =====
function saveConfig() {
  const url = document.getElementById('supabase-url').value.trim();
  const key = document.getElementById('supabase-key').value.trim();
  const bucket = document.getElementById('supabase-bucket').value.trim();
  if (!url || !key) { alert('URLã¨ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  localStorage.setItem('sb_bucket', bucket || 'glb-models');
  document.getElementById('config-saved').style.display = 'block';
  setTimeout(() => document.getElementById('config-saved').style.display = 'none', 2000);
}

function loadConfig() {
  const url = localStorage.getItem('sb_url') || '';
  const key = localStorage.getItem('sb_key') || '';
  const bucket = localStorage.getItem('sb_bucket') || 'glb-models';
  document.getElementById('supabase-url').value = url;
  document.getElementById('supabase-key').value = key;
  document.getElementById('supabase-bucket').value = bucket;
  if (url && key) {
    document.getElementById('config-card').style.borderColor = 'rgba(102,187,106,0.3)';
  }
}

// ===== FILE RENAME =====
function toSafeFilename(name) {
  // Remove extension
  const ext = name.lastIndexOf('.') > 0 ? name.slice(name.lastIndexOf('.')) : '.glb';
  const base = name.slice(0, name.lastIndexOf('.') > 0 ? name.lastIndexOf('.') : name.length);

  // Check if has non-ASCII characters
  const hasNonAscii = /[^\x00-\x7F]/.test(base);
  const hasSpecial = /[^a-zA-Z0-9_\-]/.test(base);

  if (!hasNonAscii && !hasSpecial) return name;

  // Replace non-ASCII with nothing, keep ASCII alphanumeric
  let ascii = base.replace(/[^\x00-\x7F]/g, '').replace(/[^a-zA-Z0-9_\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');

  // If nothing left, generate timestamp ID
  if (!ascii) {
    const ts = Date.now().toString(36).toUpperCase();
    ascii = 'model_' + ts;
  } else {
    ascii = ascii + '_' + Date.now().toString(36).toUpperCase();
  }

  return ascii + ext;
}

// ===== GLB LIGHT REMOVAL =====
async function removeLightsFromGLB(arrayBuffer) {
  const view = new DataView(arrayBuffer);

  // Validate GLB magic: 0x46546C67
  const magic = view.getUint32(0, true);
  if (magic !== 0x46546C67) throw new Error('GLBãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');

  const version = view.getUint32(4, true);
  // const totalLength = view.getUint32(8, true);

  // Parse chunks
  let offset = 12;
  let jsonChunkOffset = -1;
  let jsonChunkLength = 0;
  let binChunkOffset = -1;
  let binChunkLength = 0;

  while (offset < arrayBuffer.byteLength) {
    const chunkLen = view.getUint32(offset, true);
    const chunkType = view.getUint32(offset + 4, true);
    if (chunkType === 0x4E4F534A) { // JSON
      jsonChunkOffset = offset + 8;
      jsonChunkLength = chunkLen;
    } else if (chunkType === 0x004E4942) { // BIN
      binChunkOffset = offset;
      binChunkLength = chunkLen;
    }
    offset += 8 + chunkLen;
  }

  if (jsonChunkOffset < 0) throw new Error('JSONãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  // Parse JSON
  const jsonBytes = new Uint8Array(arrayBuffer, jsonChunkOffset, jsonChunkLength);
  const jsonStr = new TextDecoder().decode(jsonBytes);
  const gltf = JSON.parse(jsonStr);

  let lightsRemoved = 0;

  // 1. Remove KHR_lights_punctual extension from top-level
  if (gltf.extensions && gltf.extensions.KHR_lights_punctual) {
    lightsRemoved += (gltf.extensions.KHR_lights_punctual.lights || []).length;
    delete gltf.extensions.KHR_lights_punctual;
    if (Object.keys(gltf.extensions).length === 0) delete gltf.extensions;
  }

  // 2. Remove from extensionsUsed / extensionsRequired
  ['extensionsUsed', 'extensionsRequired'].forEach(key => {
    if (gltf[key]) {
      gltf[key] = gltf[key].filter(e => e !== 'KHR_lights_punctual');
      if (gltf[key].length === 0) delete gltf[key];
    }
  });

  // 3. Remove light references from nodes
  if (gltf.nodes) {
    gltf.nodes.forEach(node => {
      if (node.extensions && node.extensions.KHR_lights_punctual) {
        delete node.extensions.KHR_lights_punctual;
        lightsRemoved++;
        if (Object.keys(node.extensions).length === 0) delete node.extensions;
      }
    });
  }

  // Re-encode JSON (pad to 4-byte boundary with spaces)
  let newJsonStr = JSON.stringify(gltf);
  while (newJsonStr.length % 4 !== 0) newJsonStr += ' ';
  const newJsonBytes = new TextEncoder().encode(newJsonStr);

  // Rebuild GLB
  const newJsonChunkLen = newJsonBytes.length;
  let totalLen = 12 + 8 + newJsonChunkLen; // header + JSON chunk header + JSON data
  if (binChunkOffset >= 0) totalLen += 8 + binChunkLength; // BIN chunk

  const outBuffer = new ArrayBuffer(totalLen);
  const outView = new DataView(outBuffer);
  const outBytes = new Uint8Array(outBuffer);

  // Header
  outView.setUint32(0, 0x46546C67, true); // magic
  outView.setUint32(4, version, true);
  outView.setUint32(8, totalLen, true);

  // JSON chunk
  outView.setUint32(12, newJsonChunkLen, true);
  outView.setUint32(16, 0x4E4F534A, true); // JSON
  outBytes.set(newJsonBytes, 20);

  // BIN chunk (copy as-is)
  if (binChunkOffset >= 0) {
    const binStart = 20 + newJsonChunkLen;
    outView.setUint32(binStart, binChunkLength, true);
    outView.setUint32(binStart + 4, 0x004E4942, true); // BIN
    const srcBin = new Uint8Array(arrayBuffer, binChunkOffset + 8, binChunkLength);
    outBytes.set(srcBin, binStart + 8);
  }

  return { buffer: outBuffer, lightsRemoved };
}

// ===== FILE QUEUE =====
let fileQueue = []; // { file, newName, status, url }

function addFiles(files) {
  const rename = document.getElementById('opt-rename').checked;

  Array.from(files).forEach(file => {
    if (!file.name.toLowerCase().endsWith('.glb')) {
      log(`ã‚¹ã‚­ãƒƒãƒ—: ${file.name}ï¼ˆGLBãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`, 'err');
      return;
    }
    const newName = rename ? toSafeFilename(file.name) : file.name;
    fileQueue.push({ file, newName, status: 'pending', url: null, id: Math.random().toString(36).slice(2) });
  });

  renderQueue();
}

function renderQueue() {
  const container = document.getElementById('file-queue');
  const card = document.getElementById('queue-card');
  const uploadSection = document.getElementById('upload-section');

  if (fileQueue.length === 0) {
    card.style.display = 'none';
    uploadSection.style.display = 'none';
    return;
  }

  card.style.display = 'block';
  uploadSection.style.display = 'block';

  container.innerHTML = '';
  fileQueue.forEach((item, i) => {
    const nameChanged = item.newName !== item.file.name;
    const div = document.createElement('div');
    div.className = 'file-item';
    div.id = 'file-item-' + item.id;
    div.innerHTML = `
      <div class="file-icon">ğŸ“¦</div>
      <div class="file-info">
        <div class="file-orig">${escHtml(item.file.name)}</div>
        <div class="file-new">${escHtml(item.newName)}${nameChanged ? ' <span style="color:var(--warn);font-size:10px">âœ¦ å¤‰æ›</span>' : ''}</div>
        <div class="file-size">${(item.file.size / 1024 / 1024).toFixed(1)} MB</div>
        <div class="progress-wrap" id="prog-${item.id}"><div class="progress-bar" id="bar-${item.id}"></div></div>
        <div class="result-url" id="url-wrap-${item.id}">
          <div class="url-row">
            <div class="url-text" id="url-text-${item.id}"></div>
            <button class="copy-btn" id="copy-${item.id}" onclick="copyUrl('${item.id}')">ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>
      </div>
      <span class="file-status pending" id="status-${item.id}">å¾…æ©Ÿä¸­</span>
      ${item.status === 'pending' ? `<button class="file-remove" onclick="removeFile(${i})">âœ•</button>` : ''}
    `;
    container.appendChild(div);
  });
}

function removeFile(i) {
  fileQueue.splice(i, 1);
  renderQueue();
}

function clearQueue() {
  fileQueue = fileQueue.filter(f => f.status !== 'pending');
  if (fileQueue.every(f => f.status === 'done' || f.status === 'error')) fileQueue = [];
  renderQueue();
}

// ===== UPLOAD =====
async function uploadAll() {
  const sbUrl = localStorage.getItem('sb_url');
  const sbKey = localStorage.getItem('sb_key');
  const sbBucket = localStorage.getItem('sb_bucket') || 'glb-models';

  if (!sbUrl || !sbKey) {
    alert('å…ˆã«Supabaseã®è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
    return;
  }

  const btn = document.getElementById('btn-upload');
  btn.disabled = true;
  btn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
  document.getElementById('log-area').classList.add('visible');

  const removeLights = document.getElementById('opt-remove-lights').checked;

  for (const item of fileQueue) {
    if (item.status !== 'pending') continue;

    setStatus(item.id, 'processing', 'å‡¦ç†ä¸­...');
    showProgress(item.id, true);
    setProgress(item.id, 10);

    log(`å‡¦ç†ä¸­: ${item.file.name} â†’ ${item.newName}`, 'info');

    try {
      // Read file
      let arrayBuffer = await item.file.arrayBuffer();
      setProgress(item.id, 30);

      // Remove lights
      if (removeLights) {
        log(`  ãƒ©ã‚¤ãƒˆå‰Šé™¤ä¸­...`, 'info');
        try {
          const result = await removeLightsFromGLB(arrayBuffer);
          arrayBuffer = result.buffer;
          if (result.lightsRemoved > 0) {
            log(`  ãƒ©ã‚¤ãƒˆ ${result.lightsRemoved} å€‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'ok');
          } else {
            log(`  ãƒ©ã‚¤ãƒˆãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰`, 'info');
          }
        } catch(e) {
          log(`  ãƒ©ã‚¤ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰: ${e.message}`, 'err');
        }
      }

      setProgress(item.id, 60);

      // Upload to Supabase
      const blob = new Blob([arrayBuffer], { type: 'model/gltf-binary' });
      const uploadUrl = `${sbUrl}/storage/v1/object/${sbBucket}/${encodeURIComponent(item.newName)}`;

      const res = await fetch(uploadUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${sbKey}`,
          'Content-Type': 'model/gltf-binary',
          'x-upsert': 'true'
        },
        body: blob
      });

      setProgress(item.id, 90);

      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errText}`);
      }

      // Public URL
      const publicUrl = `${sbUrl}/storage/v1/object/public/${sbBucket}/${encodeURIComponent(item.newName)}`;
      item.status = 'done';
      item.url = publicUrl;
      setProgress(item.id, 100);
      setStatus(item.id, 'done', 'å®Œäº† âœ“');
      showResultUrl(item.id, publicUrl);
      log(`  âœ“ å®Œäº†: ${publicUrl}`, 'ok');

    } catch(e) {
      item.status = 'error';
      setStatus(item.id, 'error', 'ã‚¨ãƒ©ãƒ¼');
      log(`  âœ— ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
    }
  }

  btn.disabled = false;
  btn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ â†’';
  log('--- å®Œäº† ---', 'info');
}

// ===== UI HELPERS =====
function setStatus(id, cls, text) {
  const el = document.getElementById('status-' + id);
  if (el) { el.className = 'file-status ' + cls; el.textContent = text; }
}

function showProgress(id, show) {
  const el = document.getElementById('prog-' + id);
  if (el) el.classList.toggle('visible', show);
}

function setProgress(id, pct) {
  const el = document.getElementById('bar-' + id);
  if (el) el.style.width = pct + '%';
}

function showResultUrl(id, url) {
  const wrap = document.getElementById('url-wrap-' + id);
  const text = document.getElementById('url-text-' + id);
  if (wrap && text) {
    text.textContent = url;
    wrap.classList.add('visible');
  }
}

function copyUrl(id) {
  const text = document.getElementById('url-text-' + id);
  const btn = document.getElementById('copy-' + id);
  if (text) {
    navigator.clipboard.writeText(text.textContent).then(() => {
      btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'ã‚³ãƒ”ãƒ¼'; btn.classList.remove('copied'); }, 2000);
    });
  }
}

function log(msg, type = 'info') {
  const el = document.getElementById('log-content');
  const line = document.createElement('div');
  line.className = 'log-' + type;
  line.textContent = msg;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== DRAG & DROP =====
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  addFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', e => {
  addFiles(e.target.files);
  e.target.value = '';
});

// ===== INIT =====
loadConfig();
</script>
</body>
</html>
